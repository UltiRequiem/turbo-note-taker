name: Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [] # Remove dependency on other jobs to allow parallel execution

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install uv
      uses: astral-sh/setup-uv@v3

    - name: Set up Bun
      uses: oven-sh/setup-bun@v1

    - name: Install backend dependencies
      working-directory: ./backend
      run: uv sync

    - name: Install frontend dependencies
      working-directory: ./frontend
      run: bun install --frozen-lockfile

    - name: Set up test database
      working-directory: ./backend
      run: |
        # Create test database (SQLite)
        uv run python manage.py migrate
      env:
        DJANGO_SETTINGS_MODULE: notes_backend.settings

    - name: Start Django server
      working-directory: ./backend
      run: |
        uv run python manage.py runserver &
        sleep 10
      env:
        DJANGO_SETTINGS_MODULE: notes_backend.settings

    - name: Run E2E tests
      working-directory: ./frontend
      run: |
        # For now, just build and do a basic smoke test
        # Later can be replaced with actual E2E tests
        bun run build
        echo "E2E tests placeholder - add Playwright or Cypress here"
      env:
        NEXT_PUBLIC_API_BASE_URL: http://localhost:8000

    - name: Health check
      run: |
        # Basic API health check
        curl -f http://localhost:8000/api/ || echo "API not accessible"